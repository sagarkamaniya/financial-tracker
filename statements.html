<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statements</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
    <div class="w-full max-w-md sm:max-w-lg bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold text-center text-indigo-600 mb-6">Financial Tracker</h1>
        <nav class="flex flex-col sm:flex-row gap-2 mb-4">
            <a href="index.html" class="flex-1 p-2 text-center bg-gray-500 text-white rounded hover:bg-gray-600">Home</a>
            <a href="income.html" class="flex-1 p-2 text-center bg-emerald-500 text-white rounded hover:bg-emerald-600">Income</a>
            <a href="expenses.html" class="flex-1 p-2 text-center bg-blue-600 text-white rounded hover:bg-blue-700">Expenses</a>
            <a href="fuel-cost.html" class="flex-1 p-2 text-center bg-purple-600 text-white rounded hover:bg-purple-700">Fuel Cost</a>
            <a href="investments.html" class="flex-1 p-2 text-center bg-teal-600 text-white rounded hover:bg-teal-700">Investments</a>
            <a href="net-worth.html" class="flex-1 p-2 text-center bg-indigo-600 text-white rounded hover:bg-indigo-700">Net Worth</a>
            <a href="statements.html" class="flex-1 p-2 text-center bg-amber-600 text-white rounded hover:bg-amber-700">Statements</a>
            <a href="loans-lending.html" class="flex-1 p-2 text-center bg-rose-600 text-white rounded hover:bg-rose-700">Loans & Lending</a>
            <a href="settings.html" class="flex-1 p-2 text-center bg-violet-600 text-white rounded hover:bg-violet-700">Settings</a>
        </nav>

        <h2 class="text-xl font-semibold mb-4">Generate Statement</h2>
        <form id="statementForm" class="space-y-4">
            <div>
                <select id="statement-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">All</option>
                    <option value="income">Income</option>
                    <option value="expenses">Expenses</option>
                    <option value="fuel">Fuel Cost</option>
                    <option value="investments">Investments</option>
                    <option value="loans">Loans & Lending</option>
                </select>
            </div>
            <div>
                <input type="date" id="start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="date" id="end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Generate Statement</button>
        </form>

        <div id="statementSummary" class="mt-6 hidden">
            <h2 class="text-xl font-semibold mb-4">Statement Summary</h2>
            <div id="summaryData" class="space-y-2 mb-4">
                <p id="totalIncome" class="text-gray-600">Total Income: ₹0.00</p>
                <p id="totalExpenses" class="text-gray-600">Total Expenses: ₹0.00</p>
                <p id="totalFuel" class="text-gray-600">Total Fuel Cost: ₹0.00</p>
                <p id="totalInvestments" class="text-gray-600">Total Investments: ₹0.00</p>
                <p id="totalLoans" class="text-gray-600">Total Loans (Net): ₹0.00</p>
                <p id="netWorth" class="text-gray-600 font-bold">Net Worth Change: ₹0.00</p>
            </div>

            <div id="transactionList" class="space-y-4">
                <div id="incomeTransactions" class="hidden">
                    <h3 class="text-lg font-medium text-gray-700">Income Transactions</h3>
                    <ul id="incomeList" class="space-y-2"></ul>
                </div>
                <div id="expensesTransactions" class="hidden">
                    <h3 class="text-lg font-medium text-gray-700">Expenses Transactions</h3>
                    <ul id="expensesList" class="space-y-2"></ul>
                </div>
                <div id="fuelTransactions" class="hidden">
                    <h3 class="text-lg font-medium text-gray-700">Fuel Cost Transactions</h3>
                    <ul id="fuelList" class="space-y-2"></ul>
                </div>
                <div id="investmentsTransactions" class="hidden">
                    <h3 class="text-lg font-medium text-gray-700">Investments Transactions</h3>
                    <ul id="investmentsList" class="space-y-2"></ul>
                </div>
                <div id="loansTransactions" class="hidden">
                    <h3 class="text-lg font-medium text-gray-700">Loans & Lending Transactions</h3>
                    <ul id="loansList" class="space-y-2"></ul>
                </div>
            </div>

            <div class="mt-4 space-y-2">
                <button id="downloadPdf" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Download as PDF</button>
                <button id="downloadExcel" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Download as Excel</button>
            </div>
        </div>
    </div>

    <script>
        // Simulate data from other pages (replace with actual data storage in production)
        const mockData = {
            income: [
                { date: '2025-09-01', amount: 50000, category: 'Salary' },
                { date: '2025-09-05', amount: 10000, category: 'Freelance' },
                { date: '2025-09-10', amount: 2000, category: 'Other' }
            ],
            expenses: [
                { date: '2025-09-02', amount: 5000, category: 'Food' },
                { date: '2025-09-07', amount: 2000, category: 'Transport' },
                { date: '2025-09-12', amount: 1000, category: 'Bills' }
            ],
            fuelCost: [
                { date: '2025-09-03', amount: 1500, category: 'Fuel' },
                { date: '2025-09-08', amount: 1200, category: 'Fuel' }
            ],
            investments: [
                { date: '2025-09-04', amount: 10000, category: 'Stocks' },
                { date: '2025-09-11', amount: 5000, category: 'Crypto' }
            ],
            loans: [
                { date: '2025-09-06', amount: 20000, category: 'Borrowed' },
                { date: '2025-09-13', amount: -3000, category: 'Repayment' },
                { date: '2025-09-09', amount: 5000, category: 'Lent' },
                { date: '2025-09-14', amount: -1000, category: 'Repayment Received' }
            ]
        };

        // Calculate totals and filter transactions for a given date range and statement type
        function calculateTotals(startDate, endDate, statementType) {
            try {
                const start = new Date(startDate);
                const end = new Date(endDate);
                if (isNaN(start) || isNaN(end)) {
                    throw new Error('Invalid date format');
                }
                if (end < start) {
                    throw new Error('End date must be on or after start date');
                }

                const filteredData = {};
                let totalIncome = 0, totalExpenses = 0, totalFuel = 0, totalInvestments = 0, totalLoans = 0;

                const categories = statementType === 'all' ? ['income', 'expenses', 'fuelCost', 'investments', 'loans'] : 
                                  statementType === 'loans' ? ['loans'] : [statementType];

                categories.forEach(key => {
                    if (!mockData[key]) {
                        filteredData[key] = [];
                        return;
                    }
                    filteredData[key] = mockData[key].filter(item => {
                        const itemDate = new Date(item.date);
                        return !isNaN(itemDate) && itemDate >= start && itemDate <= end;
                    });

                    filteredData[key].forEach(item => {
                        const amount = parseFloat(item.amount);
                        if (isNaN(amount)) return;
                        if (key === 'income') totalIncome += amount;
                        if (key === 'expenses') totalExpenses += amount;
                        if (key === 'fuelCost') totalFuel += amount;
                        if (key === 'investments') totalInvestments += amount;
                        if (key === 'loans') totalLoans += amount;
                    });
                });

                return {
                    filteredData,
                    totals: {
                        income: totalIncome,
                        expenses: totalExpenses,
                        fuel: totalFuel,
                        investments: totalInvestments,
                        loans: totalLoans,
                        netWorth: totalIncome - totalExpenses - totalFuel + totalInvestments + totalLoans
                    }
                };
            } catch (error) {
                console.error('Error in calculateTotals:', error.message);
                alert('Error calculating totals: ' + error.message);
                return { filteredData: {}, totals: { income: 0, expenses: 0, fuel: 0, investments: 0, loans: 0, netWorth: 0 } };
            }
        }

        // Display summary and transactions
        function displaySummary(startDate, endDate, statementType, data) {
            try {
                const { totals, filteredData } = data;

                // Update totals with proper formatting
                document.getElementById('totalIncome').textContent = `Total Income: ₹${totals.income.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('totalExpenses').textContent = `Total Expenses: ₹${totals.expenses.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('totalFuel').textContent = `Total Fuel Cost: ₹${totals.fuel.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('totalInvestments').textContent = `Total Investments: ₹${totals.investments.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('totalLoans').textContent = `Total Loans (Net): ₹${totals.loans.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('netWorth').textContent = `Net Worth Change: ₹${totals.netWorth.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                // Show/hide totals based on statement type
                document.getElementById('totalIncome').style.display = statementType === 'all' || statementType === 'income' ? 'block' : 'none';
                document.getElementById('totalExpenses').style.display = statementType === 'all' || statementType === 'expenses' ? 'block' : 'none';
                document.getElementById('totalFuel').style.display = statementType === 'all' || statementType === 'fuel' ? 'block' : 'none';
                document.getElementById('totalInvestments').style.display = statementType === 'all' || statementType === 'investments' ? 'block' : 'none';
                document.getElementById('totalLoans').style.display = statementType === 'all' || statementType === 'loans' ? 'block' : 'none';
                document.getElementById('netWorth').style.display = statementType === 'all' ? 'block' : 'none';

                // Display transactions
                const transactionLists = {
                    income: document.getElementById('incomeList'),
                    expenses: document.getElementById('expensesList'),
                    fuelCost: document.getElementById('fuelList'),
                    investments: document.getElementById('investmentsList'),
                    loans: document.getElementById('loansList')
                };

                Object.keys(transactionLists).forEach(key => {
                    const list = transactionLists[key];
                    const section = document.getElementById(`${key}Transactions`);
                    if (filteredData[key]?.length > 0 && (statementType === 'all' || statementType === (key === 'fuelCost' ? 'fuel' : key))) {
                        list.innerHTML = filteredData[key].map(item => `
                            <li class="text-gray-600">
                                ${item.date} - ₹${Math.abs(item.amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${item.amount < 0 ? '(Debit)' : ''} (${item.category})
                            </li>
                        `).join('');
                        section.classList.remove('hidden');
                    } else {
                        list.innerHTML = '';
                        section.classList.add('hidden');
                    }
                });
            } catch (error) {
                console.error('Error in displaySummary:', error.message);
                alert('Error displaying summary: ' + error.message);
            }
        }

        // Download as PDF
        document.getElementById('downloadPdf').addEventListener('click', function() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const statementType = document.getElementById('statement-type').value;
                const data = calculateTotals(startDate, endDate, statementType);
                const { filteredData, totals } = data;

                doc.setFontSize(16);
                doc.text(`Financial Statement: ${startDate} to ${endDate}`, 20, 20);
                doc.setFontSize(12);
                let y = 40;

                // Add totals
                if (statementType === 'all' || statementType === 'income') {
                    doc.text(`Total Income: ₹${totals.income.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 20, y);
                    y += 10;
                }
                if (statementType === 'all' || statementType === 'expenses') {
                    doc.text(`Total Expenses: ₹${totals.expenses.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 20, y);
                    y += 10;
                }
                if (statementType === 'all' || statementType === 'fuel') {
                    doc.text(`Total Fuel Cost: ₹${totals.fuel.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 20, y);
                    y += 10;
                }
                if (statementType === 'all' || statementType === 'investments') {
                    doc.text(`Total Investments: ₹${totals.investments.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 20, y);
                    y += 10;
                }
                if (statementType === 'all' || statementType === 'loans') {
                    doc.text(`Total Loans (Net): ₹${totals.loans.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 20, y);
                    y += 10;
                }
                if (statementType === 'all') {
                    doc.text(`Net Worth Change: ₹${totals.netWorth.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 20, y);
                    y += 15;
                }

                // Add transactions
                const categories = statementType === 'all' ? ['income', 'expenses', 'fuelCost', 'investments', 'loans'] : 
                                  statementType === 'loans' ? ['loans'] : [statementType];
                categories.forEach(key => {
                    if (filteredData[key]?.length > 0) {
                        doc.text(`${key.charAt(0).toUpperCase() + key.slice(1)} Transactions:`, 20, y);
                        y += 10;
                        filteredData[key].forEach(item => {
                            doc.text(`${item.date} - ₹${Math.abs(item.amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${item.amount < 0 ? '(Debit)' : ''} (${item.category})`, 20, y);
                            y += 10;
                        });
                        y += 5;
                    }
                });

                doc.save(`statement_${statementType}_${startDate}_to_${endDate}.pdf`);
            } catch (error) {
                console.error('Error generating PDF:', error.message);
                alert('Error generating PDF: ' + error.message);
            }
        });

        // Download as Excel
        document.getElementById('downloadExcel').addEventListener('click', function() {
            try {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const statementType = document.getElementById('statement-type').value;
                const data = calculateTotals(startDate, endDate, statementType);
                const { filteredData, totals } = data;

                const wb = XLSX.utils.book_new();
                const wsData = [['Category', 'Total Amount']];
                if (statementType === 'all' || statementType === 'income') wsData.push(['Income', totals.income]);
                if (statementType === 'all' || statementType === 'expenses') wsData.push(['Expenses', totals.expenses]);
                if (statementType === 'all' || statementType === 'fuel') wsData.push(['Fuel Cost', totals.fuel]);
                if (statementType === 'all' || statementType === 'investments') wsData.push(['Investments', totals.investments]);
                if (statementType === 'all' || statementType === 'loans') wsData.push(['Loans (Net)', totals.loans]);
                if (statementType === 'all') wsData.push(['Net Worth Change', totals.netWorth]);

                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, 'Summary');

                // Add detailed sheets
                const categories = statementType === 'all' ? ['income', 'expenses', 'fuelCost', 'investments', 'loans'] : 
                                  statementType === 'loans' ? ['loans'] : [statementType];
                categories.forEach(key => {
                    if (filteredData[key]?.length > 0) {
                        const detailData = [['Date', 'Amount', 'Category'], ...filteredData[key].map(item => [item.date, item.amount, item.category])];
                        const detailWs = XLSX.utils.aoa_to_sheet(detailData);
                        XLSX.utils.book_append_sheet(wb, detailWs, key.charAt(0).toUpperCase() + key.slice(1));
                    }
                });

                XLSX.writeFile(wb, `statement_${statementType}_${startDate}_to_${endDate}.xlsx`);
            } catch (error) {
                console.error('Error generating Excel:', error.message);
                alert('Error generating Excel: ' + error.message);
            }
        });

        // Ensure DOM is loaded before attaching event listener
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('statementForm');
            if (!form) {
                console.error('Form element not found');
                return;
            }
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const statementType = document.getElementById('statement-type').value;
                if (!startDate || !endDate) {
                    alert('Please select both start and end dates.');
                    return;
                }
                const data = calculateTotals(startDate, endDate, statementType);
                displaySummary(startDate, endDate, statementType, data);
                document.getElementById('statementSummary').classList.remove('hidden');
            });
        });
    </script>
</body>
</html>