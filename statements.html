<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statements</title>
    <link href="styles.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="font-sans m-0 p-0 min-h-screen">
    <nav>
        <ul class="list-none">
            <li class="inline mr-4"><a href="index.html" class="nav-link">Home</a></li>
            <li class="inline mr-4"><a href="income.html" class="nav-link">Income</a></li>
            <li class="inline mr-4"><a href="expenses.html" class="nav-link">Expenses</a></li>
            <li class="inline mr-4"><a href="fuel-cost.html" class="nav-link">Fuel Cost</a></li>
            <li class="inline mr-4"><a href="investments.html" class="nav-link">Investments</a></li>
            <li class="inline mr-4"><a href="net-worth.html" class="nav-link">Net Worth</a></li>
            <li class="inline mr-4"><a href="statements.html" class="nav-link">Statements</a></li>
            <li class="inline mr-4"><a href="loans-lending.html" class="nav-link">Loans & Lending</a></li>
            <li class="inline mr-4"><a href="settings.html" class="nav-link">Settings</a></li>
        </ul>
    </nav>

    <main class="p-4 sm:p-8 max-w-4xl mx-auto">
        <section class="date-range mb-6 sm:mb-8">
            <h2 class="text-lg sm:text-xl font-bold mb-4">Select Date Range</h2>
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-4">
                <input type="date" id="start-date" class="border border-gray-300 rounded p-3 text-base w-full sm:w-auto">
                <input type="date" id="end-date" class="border border-gray-300 rounded p-3 text-base w-full sm:w-auto">
                <button onclick="generateStatement()" class="bg-blue-600 text-white py-3 px-4 rounded hover:bg-blue-700 text-base">Generate Statement</button>
                <button class="download-btn bg-green-500 text-white py-3 px-4 rounded hover:bg-green-600 text-base" onclick="downloadPDF()">Download as PDF</button>
            </div>
        </section>

        <section class="statement-section mb-6" id="income">
            <h2 class="text-base sm:text-lg font-semibold">Income</h2>
            <p class="text-sm sm:text-base" id="income-total">Total Income: ₹0.00</p>
        </section>

        <section class="statement-section mb-6" id="expenses">
            <h2 class="text-base sm:text-lg font-semibold">Expenses</h2>
            <p class="text-sm sm:text-base" id="expenses-total">Total Expenses: ₹0.00</p>
        </section>

        <section class="statement-section mb-6" id="fuel-costs">
            <h2 class="text-base sm:text-lg font-semibold">Fuel Costs</h2>
            <p class="text-sm sm:text-base" id="fuel-costs-total">Total Fuel Cost: ₹0.00</p>
        </section>

        <section class="statement-section mb-6" id="investments">
            <h2 class="text-base sm:text-lg font-semibold">Investments</h2>
            <p class="text-sm sm:text-base" id="investments-total">Total Investments: ₹0.00</p>
        </section>

        <section class="statement-section mb-6" id="loans">
            <h2 class="text-base sm:text-lg font-semibold">Loans (Borrowed)</h2>
            <p class="text-sm sm:text-base" id="loans-total">Total Loans: ₹0.00</p>
        </section>

        <section class="statement-section mb-6" id="lending">
            <h2 class="text-base sm:text-lg font-semibold">Lending (Lent)</h2>
            <p class="text-sm sm:text-base" id="lending-total">Total Lending: ₹0.00</p>
        </section>

        <section class="statement-section mb-6" id="repayments">
            <h2 class="text-base sm:text-lg font-semibold">Repayments</h2>
            <p class="text-sm sm:text-base" id="repayments-total">Total Repayments: ₹0.00</p>
        </section>

        <section class="statement-section mb-6" id="additional-amounts">
            <h2 class="text-base sm:text-lg font-semibold">Additional Amounts</h2>
            <p class="text-sm sm:text-base" id="additional-amounts-total">Total Additional Amounts: ₹0.00</p>
        </section>
    </main>

    <script>
        function generateStatement() {
            // Initialize local storage if empty
            if (!localStorage.getItem('financialData')) {
                localStorage.setItem('financialData', JSON.stringify({
                    income: [],
                    expenses: [],
                    fuelCosts: [],
                    investments: [],
                    loans: [],
                    lending: [],
                    repayments: [],
                    additionalAmounts: []
                }));
            }

            // Get date range
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            // Load data from local storage
            const data = JSON.parse(localStorage.getItem('financialData'));

            // Mock data fallback if no entries
            const mockData = {
                income: [{ amount: 50000.00, date: '2025-09-16' }],
                expenses: [{ amount: 30000.00, date: '2025-09-16' }],
                fuelCosts: [{ amount: 5000.00, date: '2025-09-16' }],
                investments: [{ amount: 20000.00, date: '2025-09-16' }],
                loans: [{ amount: 10000.00, date: '2025-09-16' }],
                lending: [{ amount: 15000.00, date: '2025-09-16' }],
                repayments: [{ amount: 5000.00, date: '2025-09-16' }],
                additionalAmounts: [{ amount: 2000.00, date: '2025-09-16' }]
            };

            // Use mock data if local storage is empty
            const sourceData = {
                income: data.income.length ? data.income : mockData.income,
                expenses: data.expenses.length ? data.expenses : mockData.expenses,
                fuelCosts: data.fuelCosts.length ? data.fuelCosts : mockData.fuelCosts,
                investments: data.investments.length ? data.investments : mockData.investments,
                loans: data.loans.length ? data.loans : mockData.loans,
                lending: data.lending.length ? data.lending : mockData.lending,
                repayments: data.repayments.length ? data.repayments : mockData.repayments,
                additionalAmounts: data.additionalAmounts.length ? data.additionalAmounts : mockData.additionalAmounts
            };

            // Filter by date range
            const filterByDate = (entries, start, end) => {
                if (!start || !end) return entries;
                return entries.filter(entry => {
                    const entryDate = new Date(entry.date);
                    return entryDate >= new Date(start) && entryDate <= new Date(end);
                });
            };

            // Sum amounts
            const sum = (entries) => entries.reduce((total, entry) => total + (entry.amount || 0), 0);

            // Calculate totals
            const totals = {
                income: sum(filterByDate(sourceData.income, startDate, endDate)),
                expenses: sum(filterByDate(sourceData.expenses, startDate, endDate)),
                fuelCosts: sum(filterByDate(sourceData.fuelCosts, startDate, endDate)),
                investments: sum(filterByDate(sourceData.investments, startDate, endDate)),
                loans: sum(filterByDate(sourceData.loans, startDate, endDate)),
                lending: sum(filterByDate(sourceData.lending, startDate, endDate)),
                repayments: sum(filterByDate(sourceData.repayments, startDate, endDate)),
                additionalAmounts: sum(filterByDate(sourceData.additionalAmounts, startDate, endDate))
            };

            // Update DOM
            document.getElementById('income-total').textContent = `Total Income: ₹${totals.income.toFixed(2)}`;
            document.getElementById('expenses-total').textContent = `Total Expenses: ₹${totals.expenses.toFixed(2)}`;
            document.getElementById('fuel-costs-total').textContent = `Total Fuel Cost: ₹${totals.fuelCosts.toFixed(2)}`;
            document.getElementById('investments-total').textContent = `Total Investments: ₹${totals.investments.toFixed(2)}`;
            document.getElementById('loans-total').textContent = `Total Loans: ₹${totals.loans.toFixed(2)}`;
            document.getElementById('lending-total').textContent = `Total Lending: ₹${totals.lending.toFixed(2)}`;
            document.getElementById('repayments-total').textContent = `Total Repayments: ₹${totals.repayments.toFixed(2)}`;
            document.getElementById('additional-amounts-total').textContent = `Total Additional Amounts: ₹${totals.additionalAmounts.toFixed(2)}`;

            // Enhanced error handling
            if (!data.income.length) {
                alert("Statement generated using mock data. Add data in other pages (e.g., Income, Expenses) to use real data.");
            } else {
                alert("Statement generated from local storage data.");
            }
        }

        function downloadPDF() {
            const element = document.querySelector('main');
            const opt = {
                margin: 0.5,
                filename: 'Financial_Statement.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: window.devicePixelRatio || 1 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            try {
                html2pdf().set(opt).from(element).save();
            } catch (error) {
                console.error('PDF generation failed:', error);
                alert('Failed to generate PDF. Please try again.');
            }
        }
    </script>
</body>
</html>