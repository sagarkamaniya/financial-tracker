<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statements - Financial Tracker</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
    <div class="w-full max-w-md sm:max-w-lg bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold text-center text-amber-600 mb-6">Statements</h1>
        <nav class="flex flex-col sm:flex-row gap-2 mb-4">
            <a href="index.html" class="flex-1 p-2 text-center bg-gray-500 text-white rounded hover:bg-gray-600">Home</a>
            <a href="income.html" class="flex-1 p-2 text-center bg-emerald-500 text-white rounded hover:bg-emerald-600">Income</a>
            <a href="expenses.html" class="flex-1 p-2 text-center bg-blue-600 text-white rounded hover:bg-blue-700">Expenses</a>
            <a href="fuel-cost.html" class="flex-1 p-2 text-center bg-purple-600 text-white rounded hover:bg-purple-700">Fuel Cost</a>
            <a href="investments.html" class="flex-1 p-2 text-center bg-teal-600 text-white rounded hover:bg-teal-700">Investments</a>
            <a href="net-worth.html" class="flex-1 p-2 text-center bg-indigo-600 text-white rounded hover:bg-indigo-700">Net Worth</a>
            <a href="statements.html" class="flex-1 p-2 text-center bg-amber-600 text-white rounded hover:bg-amber-700">Statements</a>
            <a href="loans-lending.html" class="flex-1 p-2 text-center bg-rose-600 text-white rounded hover:bg-rose-700">Loans & Lending</a>
            <a href="settings.html" class="flex-1 p-2 text-center bg-violet-600 text-white rounded hover:bg-violet-700">Settings</a>
        </nav>
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-amber-600 mb-2">Select Date Range</h2>
            <div class="flex gap-2 mb-2">
                <input type="date" id="startDate" class="w-1/2 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-amber-500">
                <input type="date" id="endDate" class="w-1/2 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-amber-500">
            </div>
            <button onclick="generateStatements()" class="w-full bg-amber-600 text-white p-2 rounded hover:bg-amber-700">Generate Statements</button>
        </div>
        <div id="statementsContainer" class="mb-4">
            </div>
        <div id="downloadButtons" class="hidden flex justify-center gap-2 mt-4">
            <button onclick="downloadExcel()" class="bg-green-600 text-white p-2 rounded hover:bg-green-700">Download as Excel</button>
            <button onclick="downloadPdf()" class="bg-red-600 text-white p-2 rounded hover:bg-red-700">Download as PDF</button>
        </div>
    </div>

    <script defer>
        let incomes = JSON.parse(localStorage.getItem('incomes')) || [];
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        let investments = JSON.parse(localStorage.getItem('investments')) || [];
        let repayments = JSON.parse(localStorage.getItem('repayments')) || [];
        let additions = JSON.parse(localStorage.getItem('additions')) || [];
        
        let filteredTransactions = []; // This will store the transactions for download

        function generateStatements() {
            try {
                const startDateStr = document.getElementById('startDate').value;
                const endDateStr = document.getElementById('endDate').value;
                
                if (!startDateStr || !endDateStr) {
                    alert('Please select both a start and end date.');
                    document.getElementById('downloadButtons').classList.add('hidden');
                    return;
                }

                const startDate = new Date(startDateStr);
                const endDate = new Date(endDateStr);
                endDate.setHours(23, 59, 59, 999); // Include the whole end day

                const statementsContainer = document.getElementById('statementsContainer');
                statementsContainer.innerHTML = '';
                
                if (startDate > endDate) {
                    alert('Start date cannot be after end date.');
                    document.getElementById('downloadButtons').classList.add('hidden');
                    return;
                }

                const allTransactions = [
                    ...incomes.map(item => ({ ...item, type: 'income', displayTimestamp: item.timestamp })),
                    ...expenses.map(item => ({ ...item, type: 'expense', displayTimestamp: item.timestamp })),
                    ...investments.map(item => ({ ...item, type: 'investment', displayTimestamp: item.timestamp })),
                    ...repayments.map(item => ({ ...item, type: 'repayment', description: `Repayment on Loan/Lending ID: ${item.loanId}`, displayTimestamp: item.timestamp })),
                    ...additions.map(item => ({ ...item, type: 'addition', description: `Additional amount on Loan/Lending ID: ${item.loanId}`, displayTimestamp: item.timestamp }))
                ];
                
                // Filter transactions by date range
                filteredTransactions = allTransactions.filter(transaction => {
                    const transactionDate = new Date(transaction.displayTimestamp.split(',')[0].trim());
                    transactionDate.setHours(0, 0, 0, 0);
                    return transactionDate >= startDate && transactionDate <= endDate;
                }).sort((a, b) => new Date(a.displayTimestamp) - new Date(b.displayTimestamp));
                
                if (filteredTransactions.length === 0) {
                    statementsContainer.innerHTML = '<p class="text-center text-gray-500">No transactions found for the selected date range.</p>';
                    document.getElementById('downloadButtons').classList.add('hidden');
                    return;
                }
                
                renderStatements(filteredTransactions, statementsContainer);
                document.getElementById('downloadButtons').classList.remove('hidden');
            } catch (e) {
                console.error('Error in generateStatements:', e);
                alert('An error occurred while generating statements. Please try again.');
            }
        }
        
        function renderStatements(transactions, container) {
            let totalIncome = 0;
            let totalExpenses = 0;
            let totalInvestments = 0;
            let totalRepayments = 0;
            let totalAdditions = 0;
        
            const listDiv = document.createElement('div');
            listDiv.className = 'flex flex-col gap-2';
        
            transactions.forEach(transaction => {
                const div = document.createElement('div');
                let textColor = 'text-gray-700';
                let amountText = `₹${transaction.amount.toFixed(2)}`;
        
                switch(transaction.type) {
                    case 'income':
                        textColor = 'text-emerald-600';
                        totalIncome += transaction.amount;
                        break;
                    case 'expense':
                        textColor = 'text-blue-600';
                        totalExpenses += transaction.amount;
                        break;
                    case 'investment':
                        textColor = 'text-teal-600';
                        totalInvestments += transaction.amount;
                        break;
                    case 'repayment':
                        textColor = 'text-rose-600';
                        totalRepayments += transaction.amount;
                        break;
                    case 'addition':
                        textColor = 'text-rose-600';
                        totalAdditions += transaction.amount;
                        break;
                }
        
                div.className = 'p-2 border-b border-gray-200';
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="font-medium ${textColor}">${transaction.description}</span>
                            <span class="text-sm text-gray-500">(${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}, ${transaction.displayTimestamp})</span>
                        </div>
                        <span class="${textColor} font-semibold">${amountText}</span>
                    </div>
                `;
                listDiv.appendChild(div);
            });
        
            container.appendChild(listDiv);
        
            // Summary section
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'mt-4 pt-4 border-t border-gray-300';
            summaryDiv.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Summary</h3>
                <p class="flex justify-between items-center text-emerald-600">Total Income: <span class="font-bold">₹${totalIncome.toFixed(2)}</span></p>
                <p class="flex justify-between items-center text-blue-600">Total Expenses: <span class="font-bold">₹${totalExpenses.toFixed(2)}</span></p>
                <p class="flex justify-between items-center text-teal-600">Total Investments: <span class="font-bold">₹${totalInvestments.toFixed(2)}</span></p>
                <p class="flex justify-between items-center text-rose-600">Total Repayments: <span class="font-bold">₹${totalRepayments.toFixed(2)}</span></p>
                <p class="flex justify-between items-center text-rose-600">Total Additional Amounts: <span class="font-bold">₹${totalAdditions.toFixed(2)}</span></p>
            `;
            container.appendChild(summaryDiv);
        }

        // Download functionality
        function downloadExcel() {
            if (filteredTransactions.length === 0) {
                alert('No data to download.');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Description,Type,Amount\n";

            filteredTransactions.forEach(item => {
                const row = [
                    `"${item.displayTimestamp}"`,
                    `"${item.description}"`,
                    `"${item.type.charAt(0).toUpperCase() + item.type.slice(1)}"`,
                    item.amount.toFixed(2)
                ].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "financial_statements.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadPdf() {
            window.print();
        }
    </script>
</body>
</html>