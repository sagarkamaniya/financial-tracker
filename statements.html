<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statements</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
    <div class="w-full max-w-md sm:max-w-lg bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold text-center text-indigo-600 mb-6">Financial Tracker</h1>
        <nav class="flex flex-col sm:flex-row gap-2 mb-4">
            <a href="index.html" class="flex-1 p-2 text-center bg-gray-500 text-white rounded hover:bg-gray-600">Home</a>
            <a href="income.html" class="flex-1 p-2 text-center bg-emerald-500 text-white rounded hover:bg-emerald-600">Income</a>
            <a href="expenses.html" class="flex-1 p-2 text-center bg-blue-600 text-white rounded hover:bg-blue-700">Expenses</a>
            <a href="fuel-cost.html" class="flex-1 p-2 text-center bg-purple-600 text-white rounded hover:bg-purple-700">Fuel Cost</a>
            <a href="investments.html" class="flex-1 p-2 text-center bg-teal-600 text-white rounded hover:bg-teal-700">Investments</a>
            <a href="net-worth.html" class="flex-1 p-2 text-center bg-indigo-600 text-white rounded hover:bg-indigo-700">Net Worth</a>
            <a href="statements.html" class="flex-1 p-2 text-center bg-amber-600 text-white rounded hover:bg-amber-700">Statements</a>
            <a href="loans-lending.html" class="flex-1 p-2 text-center bg-rose-600 text-white rounded hover:bg-rose-700">Loans & Lending</a>
            <a href="settings.html" class="flex-1 p-2 text-center bg-violet-600 text-white rounded hover:bg-violet-700">Settings</a>
        </nav>

        <h2 class="text-xl font-semibold mb-4">Generate Statement</h2>
        <form id="statementForm" class="space-y-4">
            <div>
                <select id="statement-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">All</option>
                    <option value="income">Income</option>
                    <option value="expenses">Expenses</option>
                    <option value="investments">Investments</option>
                    <option value="loans">Loans & Lending</option>
                </select>
            </div>
            <div>
                <input type="date" id="start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="date" id="end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Generate Statement</button>
        </form>

        <div id="statementSummary" class="mt-6 hidden">
            <h2 class="text-xl font-semibold mb-4">Statement Summary</h2>
            <div id="summaryData" class="space-y-2 mb-4">
                <p id="totalIncome" class="text-gray-600">Total Income: ₹0.00</p>
                <p id="totalExpenses" class="text-gray-600">Total Expenses: ₹0.00</p>
                <p id="totalInvestments" class="text-gray-600">Total Investments: ₹0.00</p>
                <p id="totalLoans" class="text-gray-600">Total Loans (Net): ₹0.00</p>
            </div>

            <div id="transactionList" class="space-y-4">
                <div id="incomeTransactions" class="hidden">
                    <h3 class="text-lg font-medium text-gray-700">Income Transactions</h3>
                    <ul id="incomeList" class="space-y-2"></ul>
                </div>
                <div id="expensesTransactions" class="hidden">
                    <h3 class="text-lg font-medium text-gray-700">Expenses Transactions</h3>
                    <ul id="expensesList" class="space-y-2"></ul>
                </div>
                <div id="investmentsTransactions" class="hidden">
                    <h3 class="text-lg font-medium text-gray-700">Investments Transactions</h3>
                    <ul id="investmentsList" class="space-y-2"></ul>
                </div>
                <div id="loansTransactions" class="hidden">
                    <h3 class="text-lg font-medium text-gray-700">Loans & Lending Transactions</h3>
                    <ul id="loansList" class="space-y-2"></ul>
                </div>
            </div>

            <div class="mt-4 space-y-2">
                <button id="downloadPdf" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Download as PDF</button>
                <button id="downloadExcel" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Download as Excel</button>
            </div>
        </div>
    </div>

    <script>
        // Parse date in multiple formats (DD/MM/YYYY, YYYY-MM-DD, or ISO)
        function parseDate(timestamp) {
            if (!timestamp) return '';
            // Try DD/MM/YYYY
            const ddmmyyyy = timestamp.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (ddmmyyyy) {
                const [, day, month, year] = ddmmyyyy;
                const date = new Date(`${year}-${month}-${day}`);
                if (!isNaN(date)) return date.toISOString().split('T')[0];
            }
            // Try ISO or other formats
            const date = new Date(timestamp);
            if (!isNaN(date)) return date.toISOString().split('T')[0];
            console.warn(`Invalid timestamp format: ${timestamp}`);
            return '';
        }

        // Retrieve data from localStorage with validation
        function getFinancialData() {
            const categories = {
                income: 'incomes',
                expenses: 'expenses',
                investments: 'investments',
                loans: 'loans'
            };
            const financialData = {};

            console.log('localStorage contents:');
            Object.entries(categories).forEach(([category, key]) => {
                const data = localStorage.getItem(key);
                console.log(`${key}:`, data ? JSON.parse(data) : 'null');
                if (!data) {
                    console.warn(`No data found in localStorage for ${key}. Ensure data is added in the ${category.charAt(0).toUpperCase() + category.slice(1)} page.`);
                }
            });

            Object.keys(categories).forEach(category => {
                try {
                    const data = JSON.parse(localStorage.getItem(categories[category]));
                    if (Array.isArray(data)) {
                        financialData[category] = data.map(item => {
                            // Validate required fields
                            if (!item) return null;
                            if (category === 'loans' && (!item.principal || !item.type)) {
                                console.warn(`Invalid loan entry, missing principal or type:`, item);
                                return null;
                            }
                            if (category !== 'loans' && !item.amount) {
                                console.warn(`Invalid ${category} entry, missing amount:`, item);
                                return null;
                            }
                            // Skip fuel cost expenses only if explicitly marked
                            if (category === 'expenses' && item.description && item.description.startsWith('Fuel Cost on ')) {
                                console.log(`Skipping fuel cost expense: ${item.description}`);
                                return null;
                            }
                            const date = parseDate(item.timestamp || item.date);
                            const amount = category === 'loans' ? parseFloat(item.principal || 0) * (item.type === 'loan' ? -1 : 1) : parseFloat(item.amount || 0);
                            const categoryName = category === 'loans' ? (item.type === 'loan' ? 'Loan (Borrowed)' : 'Lending (Lent)') : item.category || 'Unknown';
                            return {
                                date,
                                amount,
                                category: categoryName
                            };
                        }).filter(item => item && item.date && !isNaN(item.amount));
                        if (financialData[category].length === 0 && data.length > 0) {
                            console.warn(`No valid ${category} entries after transformation. Check timestamp/date format or required fields. Raw data:`, data);
                        }
                    } else {
                        console.warn(`Invalid data format for ${categories[category]}, using empty array`);
                        financialData[category] = [];
                    }
                } catch (error) {
                    console.warn(`Error parsing ${categories[category]} from localStorage:`, error.message);
                    financialData[category] = [];
                }
            });

            return financialData;
        }

        // Calculate totals and filter transactions for a given date range and statement type
        function calculateTotals(startDate, endDate, statementType) {
            try {
                const start = new Date(startDate);
                const end = new Date(endDate);
                if (isNaN(start) || isNaN(end)) {
                    throw new Error('Invalid date format');
                }
                if (end < start) {
                    throw new Error('End date must be on or after start date');
                }

                const financialData = getFinancialData();
                const filteredData = {};
                let totalIncome = 0, totalExpenses = 0, totalInvestments = 0, totalLoans = 0;

                const categories = statementType === 'all' ? ['income', 'expenses', 'investments', 'loans'] :
                                  statementType === 'loans' ? ['loans'] : [statementType];

                categories.forEach(key => {
                    if (!financialData[key]) {
                        filteredData[key] = [];
                        console.warn(`No data for ${key} in date range ${startDate} to ${endDate}`);
                        return;
                    }
                    filteredData[key] = financialData[key].filter(item => {
                        const itemDate = new Date(item.date);
                        return !isNaN(itemDate) && itemDate >= start && itemDate <= end;
                    });

                    if (filteredData[key].length === 0 && financialData[key].length > 0) {
                        console.warn(`No ${key} entries in date range ${startDate} to ${endDate}. Available dates:`, financialData[key].map(item => item.date));
                    }

                    filteredData[key].forEach(item => {
                        const amount = parseFloat(item.amount);
                        if (isNaN(amount)) {
                            console.warn(`Invalid amount in ${key}:`, item);
                            return;
                        }
                        if (key === 'income') totalIncome += amount;
                        if (key === 'expenses') totalExpenses += amount;
                        if (key === 'investments') totalInvestments += amount;
                        if (key === 'loans') totalLoans += amount;
                    });
                });

                return {
                    financialData,
                    filteredData,
                    totals: {
                        income: totalIncome,
                        expenses: totalExpenses,
                        investments: totalInvestments,
                        loans: totalLoans
                    }
                };
            } catch (error) {
                console.error('Error in calculateTotals:', error.message);
                alert('Error calculating totals: ' + error.message);
                return { financialData: {}, filteredData: {}, totals: { income: 0, expenses: 0, investments: 0, loans: 0 } };
            }
        }

        // Display summary and transactions
        function displaySummary(startDate, endDate, statementType, data) {
            try {
                const statementSummary = document.getElementById('statementSummary');
                if (!statementSummary) {
                    throw new Error('Statement summary element not found');
                }

                const { financialData, filteredData, totals } = data;

                const totalIncomeEl = document.getElementById('totalIncome');
                const totalExpensesEl = document.getElementById('totalExpenses');
                const totalInvestmentsEl = document.getElementById('totalInvestments');
                const totalLoansEl = document.getElementById('totalLoans');

                if (!totalIncomeEl || !totalExpensesEl || !totalInvestmentsEl || !totalLoansEl) {
                    throw new Error('One or more summary elements not found');
                }

                totalIncomeEl.textContent = `Total Income: ₹${totals.income.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                totalExpensesEl.textContent = `Total Expenses: ₹${totals.expenses.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                totalInvestmentsEl.textContent = `Total Investments: ₹${totals.investments.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                totalLoansEl.textContent = `Total Loans (Net): ₹${totals.loans.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                totalIncomeEl.style.display = statementType === 'all' || statementType === 'income' ? 'block' : 'none';
                totalExpensesEl.style.display = statementType === 'all' || statementType === 'expenses' ? 'block' : 'none';
                totalInvestmentsEl.style.display = statementType === 'all' || statementType === 'investments' ? 'block' : 'none';
                totalLoansEl.style.display = statementType === 'all' || statementType === 'loans' ? 'block' : 'none';

                const transactionLists = {
                    income: { list: document.getElementById('incomeList'), section: document.getElementById('incomeTransactions') },
                    expenses: { list: document.getElementById('expensesList'), section: document.getElementById('expensesTransactions') },
                    investments: { list: document.getElementById('investmentsList'), section: document.getElementById('investmentsTransactions') },
                    loans: { list: document.getElementById('loansList'), section: document.getElementById('loansTransactions') }
                };

                Object.keys(transactionLists).forEach(key => {
                    const { list, section } = transactionLists[key];
                    if (!list || !section) {
                        console.warn(`Transaction list or section for ${key} not found`);
                        return;
                    }
                    if (filteredData[key]?.length > 0 && (statementType === 'all' || statementType === key)) {
                        list.innerHTML = filteredData[key].map(item => `
                            <li class="text-gray-600">
                                ${item.date} - ₹${Math.abs(item.amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${item.amount < 0 ? '(Debit)' : ''} (${item.category})
                            </li>
                        `).join('');
                        section.classList.remove('hidden');
                    } else {
                        list.innerHTML = '';
                        section.classList.add('hidden');
                    }
                });

                statementSummary.classList.remove('hidden');

                const selectedCategories = statementType === 'all' ? Object.keys(transactionLists) : [statementType];
                const missingCategories = selectedCategories.filter(key => filteredData[key].length === 0 && financialData[key].length === 0);
                if (missingCategories.length > 0) {
                    const categoryNames = missingCategories.map(key => key.charAt(0).toUpperCase() + key.slice(1));
                    alert(`No data found for ${categoryNames.join(', ')}. Please add entries in the respective pages.`);
                }
            } catch (error) {
                console.error('Error in displaySummary:', error.message);
                alert('Error displaying summary: ' + error.message);
            }
        }

        // Download as PDF
        function downloadPDF() {
            try {
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    throw new Error('jsPDF library not loaded');
                }
                const doc = new jsPDF();
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const statementType = document.getElementById('statement-type').value;
                const data = calculateTotals(startDate, endDate, statementType);
                const { filteredData, totals } = data;

                doc.setFontSize(16);
                doc.text(`Financial Statement: ${startDate} to ${endDate}`, 20, 20);
                doc.setFontSize(12);
                let y = 40;

                if (statementType === 'all' || statementType === 'income') {
                    doc.text(`Total Income: ₹${totals.income.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 20, y);
                    y += 10;
                }
                if (statementType === 'all' || statementType === 'expenses') {
                    doc.text(`Total Expenses: ₹${totals.expenses.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 20, y);
                    y += 10;
                }
                if (statementType === 'all' || statementType === 'investments') {
                    doc.text(`Total Investments: ₹${totals.investments.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 20, y);
                    y += 10;
                }
                if (statementType === 'all' || statementType === 'loans') {
                    doc.text(`Total Loans (Net): ₹${totals.loans.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 20, y);
                    y += 10;
                }

                const categories = statementType === 'all' ? ['income', 'expenses', 'investments', 'loans'] :
                                  statementType === 'loans' ? ['loans'] : [statementType];
                categories.forEach(key => {
                    if (filteredData[key]?.length > 0) {
                        doc.text(`${key.charAt(0).toUpperCase() + key.slice(1)} Transactions:`, 20, y);
                        y += 10;
                        filteredData[key].forEach(item => {
                            doc.text(`${item.date} - ₹${Math.abs(item.amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${item.amount < 0 ? '(Debit)' : ''} (${item.category})`, 20, y);
                            y += 10;
                        });
                        y += 5;
                    }
                });

                doc.save(`statement_${statementType}_${startDate}_to_${endDate}.pdf`);
            } catch (error) {
                console.error('Error generating PDF:', error.message);
                alert('Error generating PDF: ' + error.message);
            }
        }

        // Download as Excel
        function downloadExcel() {
            try {
                if (!XLSX) {
                    throw new Error('XLSX library not loaded');
                }
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const statementType = document.getElementById('statement-type').value;
                const data = calculateTotals(startDate, endDate, statementType);
                const { filteredData, totals } = data;

                const wb = XLSX.utils.book_new();
                const wsData = [['Category', 'Total Amount']];
                if (statementType === 'all' || statementType === 'income') wsData.push(['Income', totals.income]);
                if (statementType === 'all' || statementType === 'expenses') wsData.push(['Expenses', totals.expenses]);
                if (statementType === 'all' || statementType === 'investments') wsData.push(['Investments', totals.investments]);
                if (statementType === 'all' || statementType === 'loans') wsData.push(['Loans (Net)', totals.loans]);

                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, 'Summary');

                const categories = statementType === 'all' ? ['income', 'expenses', 'investments', 'loans'] :
                                  statementType === 'loans' ? ['loans'] : [statementType];
                categories.forEach(key => {
                    if (filteredData[key]?.length > 0) {
                        const detailData = [['Date', 'Amount', 'Category'], ...filteredData[key].map(item => [item.date, item.amount, item.category])];
                        const detailWs = XLSX.utils.aoa_to_sheet(detailData);
                        XLSX.utils.book_append_sheet(wb, detailWs, key.charAt(0).toUpperCase() + key.slice(1));
                    }
                });

                XLSX.writeFile(wb, `statement_${statementType}_${startDate}_to_${endDate}.xlsx`);
            } catch (error) {
                console.error('Error generating Excel:', error.message);
                alert('Error generating Excel: ' + error.message);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded');
            console.log('Initial localStorage check:', getFinancialData());

            const form = document.getElementById('statementForm');
            if (!form) {
                console.error('Form element not found');
                alert('Form element not found. Please check the HTML.');
                return;
            }
            console.log('Form element found, attaching submit listener');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Form submitted');
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const statementType = document.getElementById('statement-type').value;
                console.log('Inputs:', { startDate, endDate, statementType });
                if (!startDate || !endDate) {
                    alert('Please select both start and end dates.');
                    console.log('Date validation failed');
                    return;
                }
                const data = calculateTotals(startDate, endDate, statementType);
                console.log('Calculated data:', data);
                displaySummary(startDate, endDate, statementType, data);
            });

            const downloadPdfBtn = document.getElementById('downloadPdf');
            if (downloadPdfBtn) {
                downloadPdfBtn.addEventListener('click', downloadPDF);
            } else {
                console.error('Download PDF button not found');
            }

            const downloadExcelBtn = document.getElementById('downloadExcel');
            if (downloadExcelBtn) {
                downloadExcelBtn.addEventListener('click', downloadExcel);
            } else {
                console.error('Download Excel button not found');
            }
        });
    </script>
</body>
</html>